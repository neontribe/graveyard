<?php

/**
 * @file
 * NT2 Entity Module File
 */
error_reporting(E_ALL);
ini_set('display_errors', TRUE);
ini_set('display_startup_errors', TRUE);


function nt2_entity_entity_info() {
	$info = array();

	$info['cottage'] = array(
		'label' => t('Cottage Entity'),
		'base table' => 'cottages',
		'entity keys' => array(
			'id' => 'id',
			'label' => 'name'
		),
		'module' => 'nt2_entity',
		'entity class' => 'Entity',
		'controller class' => 'nt2EntityEntityController',
	);

	return $info;
};

function nt2_entity_menu() {
  $items = array();

  $items['nt2_test'] = array(
    'title' => 'nt2_test',
    'page callback' => 'nt2_entity_test_view',
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM
  );

  $items['nt2_test/%/node'] = array(
    'title' => 'nt2_test',
    'page callback' => 'nt2_entity_test_view',
    'page arguments' => array(1, 2),
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM
  );

  $items['nt2_test/%/teaser'] = array(
    'title' => 'nt2_test',
    'page callback' => 'nt2_entity_test_view',
    'page arguments' => array(1, 2),
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM
  );

  $items['admin/config/nt2_entity'] = array(
    'title' => 'NT2 Entity',
    'position' => 'right',
    'weight' => -25,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
  );

  $items['admin/config/nt2_entity/entity'] = array(
    'title' => 'NT2 Entity',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nt2_entity_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'nt2_entity.admin.inc',
  );

  return $items;
}


function nt2_entity_test_view($propref, $type) {
  $items = array();
	//Test that the api works
	// $path = sprintf('property/' . strtoupper("A241") . '_ZZ');
	// $data = NeontabsIO::getInstance()->get($path);
	// dpm($data);

	//Load the first cottage in the database (added manually)
	// $cottages = entity_load('cottage', FALSE);
	// $list = entity_view('cottage', $cottages);

	// if(array_key_exists('cottage', $list)) {
	// 	foreach ($list['cottage'] as $cottage) {
	// 		$items[] = drupal_render($cottage);
	// 	}

	// }

	// if(!isset($cottages[1000])) {
	// 	$entity = entity_create('cottage', array('id' => 1000));
	// 	$entity->reference = t('6969');
	// 	$entity->brandcode = t('6969');
	// 	$entity->name = t('Spring House');
	// 	$entity->save();
	// }

  if ($type == 'node') {
    $theme_fn = 'nt2_entity_node';
  }
  elseif ($type == 'teaser') {
    $theme_fn = 'nt2_entity_teaser';
  }
  else {
    return implode($items);
  }

  $widget = array(
    '#theme' => $theme_fn,
    '#property' => entity_load($propref),
  );

  return $widget;
}

/**
 * https://api.drupal.org/api/drupal/modules%21system%21system.api.php/function/hook_theme/7.x
 *
 * Implements hook_theme().
 */
function nt2_entity_theme() {
  return array(
    'nt2_entity_node' => array(
      'variables' => array(
        'property' => NULL
      ),
      'template' => 'templates/nt2_entity_node',
    ),
    'nt2_entity_teaser' => array(
      'variables' => array(
        'property' => NULL
      ),
      'template' => 'templates/nt2_entity_tesaer',
    ),
  );
}
