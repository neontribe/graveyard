<?php

/**
 * @file
 * The main nt2_landing module file.
 */

/**
 * Implements hook_module.
 */
function nt2_landing_module() {

}

/**
 * Implements hook_menu.
 */
function nt2_landing_menu() {
  $items = array();

  $items['nt2_landing'] = array(
    'title' => 'NT2 Landing Page',
    'page callback' => 'nt2_landing_callback',
    'access callback' => TRUE,
    'expanded' => TRUE,
  );

  $items['nt2_landing/nt2_landing_search_node_by_title_callback'] = array(
    'page callback' => 'nt2_landing_search_node_by_title_callback',
    // 'file' => 'nt2_landing.module',.
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Page callback for nt2_landing.
 */
function nt2_landing_callback() {

}

/**
 * Implements hook_block_info().
 */
function nt2_landing_block_info() {
  $blocks = array();

  $blocks['nt2_landing'] = array(
    'info' => t('NT2: landing block.'),
    'cache' => DRUPAL_NO_CACHE,
    'region' => 'content',
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => '<front>',
    // Status of 1 means enabled.
    'status' => 1,
  );

  $blocks['nt2_landing_multi'] = array(
    'info' => t('NT2: landing blocks.'),
    'cache' => DRUPAL_NO_CACHE,
    'region' => 'content',
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => '<front>',
    // Status of 1 means enabled.
    'status' => 1,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function nt2_landing_block_view($delta) {
  $block = array();

  $block['subject'] = t('Landing Pages');

  if ($delta === 'nt2_landing') {
    $node_landing_single_selection = variable_get('node_landing_single_selection');

    $matches = array();
    // Check for instances of a valid node ID encapsulated by '[]'. eg: `[444]`.
    $matched = preg_match("/\[[0-9]+\]/", $node_landing_single_selection, $matches);

    // If there are matches and there is only one match.
    if ($matched && count($matches) == 1) {
      // Strip out `[]` leaving just the node id.
      $node_id = preg_replace('/((\[)|(\]))/', '', $matches[0]);
      $loaded_matched_node = node_load($node_id);

      // If the node could be loaded call node_view with the node object and output to the block.
      if ($loaded_matched_node) {
        $temp_view = node_view($loaded_matched_node, 'teaser');
        $block['content'] = $temp_view;
      }
    }
    else {
      $block['content'] = array(
        '#markup' => "$node_landing_single_selection is not a valid ID."
      );
    }
  }
  elseif ($delta === 'nt2_landing_multi') {

  }

  return $block;
}

/**
 * Callback for landing page node search by title, returns JSON.
 */
function nt2_landing_search_node_by_title_callback($string = "") {
  $matches = array();

  if ($string) {
    $query = new EntityFieldQuery();
    $entities = $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', variable_get("COTTAGE_LANDING_PAGE_MACHINE_NAME"))
      ->propertyCondition('title', db_like($string) . '%', 'LIKE')
      ->execute();

    $loaded_nodes = node_load_multiple(array_keys($entities['node']));

    foreach ($loaded_nodes as $node) {
      $landing_title = $node->title;

      $matches[$landing_title . " [$node->nid]"] = check_plain($landing_title);
    }
  }

  drupal_json_output($matches);
}

/**
 * Implements hook_block_configure.
 */
function nt2_landing_block_configure($delta) {
  $form = array();
  if ($delta == 'nt2_landing') {

    $form['node_landing_single_selection'] = array(
      '#type' => 'textfield',
      '#title' => t('Choose a landing page.'),
      '#default_value' => t(variable_get('node_landing_single_selection')),
    // The autocomplete path is provided in hook_menu in ajax_example.module.
      '#autocomplete_path' => 'nt2_landing/nt2_landing_search_node_by_title_callback',
    );

  }
  return $form;

}

/**
 * Implements hook_block_save.
 */
function nt2_landing_block_save($delta = '', $edit = array()) {
  if ($delta == 'nt2_landing') {
    variable_set('node_landing_single_selection', $edit['node_landing_single_selection']);
  }
}

/**
 * Implements hook_theme().
 */
function nt2_landing_theme() {
  $theme = array();

  $theme['nt2_landing_block_theme'] = array();

  return $theme;
}
